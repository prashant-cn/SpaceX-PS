<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    
</head>
<body>

    <section class="spacex">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1><strong>SpaceX Launch Programs</strong></h1>
                </div>
                <div class="col-md-3">
                    <div class="filter">
                        <h2>Filters</h2>
                        <p id="clearSelection">Clear Selection</p>
                        <p>Launch Year</p>
                        <ul class="filter_list" id="launch_year">
                            <% projects.uniqueYears.forEach((year, index)=>{ %>
                            <li><%=year%></li>
                            <% }) %>
                        </ul>
                        <p>Successful Launch</p>
                        <ul class="filter_list" id="launch_success">
                            <li>True</li>
                            <li>False</li>
                        </ul>
                        <p>Successful Landing</p>
                        <ul class="filter_list" id="land_success">
                            <li>True</li>
                            <li>False</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="filtered_card">
                        <div class="row filteredResults">
                            <%if(error && !projects) {%>
                                <p><%=(error)?error:"No Projects Found"%></p>
                            <% } else { %>
                            <% projects.projects.forEach((project, index)=>{ %>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="space_card">
                                    <img src="<%=project.links.mission_patch_small%>" >
                                    <h2><%=project.mission_name%> #<%=project.flight_number%></h2>
                                    <h3>Mission Ids</h3>
                                    <ul class="space_list">
                                        <li>(List mission ids)</li>
                                    </ul>
                                    <p><strong>Launch Year:</strong> <%=project.launch_year%></p>
                                    <p><strong>Successful launch:</strong> <%=project.launch_success%></p>
                                    <p><strong>Successful landing:</strong> <%=(project.rocket.first_stage.cores[0].land_success)?project.rocket.first_stage.cores[0].land_success : "Not Available"%></p>
                                </div>
                            </div>
                            <% }) %>
                            <% } %>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <p class="copyrights"><strong>Developed by:</strong> Prashant</p>
                </div>
            </div>
        </div>
    </section>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>

        let filters = new Object()
        
        function getEventTarget(e) {
            e = e || window.event;
            e.target.setAttribute('class', 'selected')
            return e.target || e.srcElement; 
        }

        
        const clearButton = document.querySelector('#clearSelection')
        clearButton.addEventListener('click', (event)=>{
            if(location.search){
                $('.filter').find("*").removeClass("selected");
                //update url
                window.history.pushState(null, null, `/`);
                getData('/filtered')
            }
        })
            
        
        Array.from(document.getElementsByClassName('filter_list'))
        .forEach((element)=>{
            element.addEventListener('click', (event)=>{

                $(element).find("*").removeClass("selected");
                var filterKey = element.id
                var filterValue = getEventTarget(event).innerHTML.toLowerCase();

                filters[element.id] = filterValue
                var urlParams = $.param( filters );
                //update url
                window.history.pushState(null, null, `/filters?${urlParams}`);
                //const queryString = location.pathname+location.search
                getData(location.search) 
            })
        })

        function getData(queryString){
            $.ajax({url: `/filtered${queryString}`, success: function(result){
                $(".filteredResults").html(result);
            }}); 
        }
        
    </script>

</body>
</html>